
Migration package to fix any scheduled messages that are missing UUIDs.
Installs a view and then updates documents in that view using the bulk docs
API. Results from the bulk docs requests are printed on stdout.

Requirements:

  curl
  node >= 0.12

Environment Variables:

  COUCH_URL
  
    The URL to the CouchDB to update e.g. http://admin:secret@localhost:5984

  PREFIX
  
    The directory you want to save backup data and bulk edit results to.
    Defaults to the current directory ".".
      e.g.  /home/jane/medic-projects-1032/

  DEBUG 
  
    When set to a value it's the output will be more verbose.

Automated:

  There is a shell script that automates applying the migration and doing a
  backup of the view data, this should be all you need to do:

    ./run

Manual:

Install:

  Add a new design doc and view:

    export COUCH_URL=http://admin:secret@localhost:5984 && \
    curl -H 'content-type:application/json' -d@design-doc.json $COUCH_URL/medic

Backup:

  You should backup your data before applying bulk edits.  Copy your database
  or backup your data some other way. For example:

    ddoc='_design/migrations-add-uuid-to-scheduled-tasks'
    view='scheduled-tasks-no-uuids'
    curl $COUCH_URL/medic/$ddoc/_view/$view?include_docs=true | gzip > backup.json.gz

Run the bulk updates:

  node add-uuid-to-scheduled-tasks.js | tee -a results 

Test:

  Confirm the `total_rows` property on the view is 0:

    ddoc='_design/migrations-add-uuid-to-scheduled-tasks'
    view='scheduled-tasks-no-uuids'
    curl -s $COUCH_URL/medic/$ddoc/_view/$view | head | grep total_rows

Cleanup:

  Delete the design doc:

    ddoc='_design/migrations-add-uuid-to-scheduled-tasks'
    rev=`curl $COUCH_URL/medic/$ddoc | jq --raw-output ._rev`
    curl -X DELETE $COUCH_URL/medic/$ddoc?rev=$rev

